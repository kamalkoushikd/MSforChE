{% extends "layout.html" %}
{%load static%}
{%block title%}
Login Page
{% endblock %}
{% block head %}
    <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js"></script>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <h2>Login</h2>
        <button onclick="googleLogin()" class="btn btn-danger">Google</button>
    </div>

    
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-analytics.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBfy8xJ0PsiY0iGDHwx1LeX2GnTDN-8K-E",
          authDomain: "matscienceweb.firebaseapp.com",
          projectId: "matscienceweb",
          storageBucket: "matscienceweb.appspot.com", // ✅ Fixed this
          messagingSenderId: "675001569247",
          appId: "1:675001569247:web:ab3349b822b00b46cefe6a",
          measurementId: "G-280YE5175R"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);


        // Set persistence to LOCAL
        setPersistence(auth, browserLocalPersistence)
            .then(() => {
                console.log("Persistence set to local");
            })
            .catch((error) => {
                console.error("Error setting persistence:", error);
            });

        async function googleLogin() {
            const provider = new GoogleAuthProvider();

            try {
                const result = await signInWithPopup(auth, provider).then((result) => {
                    console.log("logged in",result);
                }).catch((error) => {
                    console.log("error",error);
                });
                const user = result.user;
                const token = await user.getIdToken();

                console.log("User signed in:", user);
                console.log("ID Token:", token);

                const response = await fetch('/firebase-login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (data.status === 'success') {
                    window.location.replace('/'); // ✅ Clean redirect
                } else {
                    console.error("Authentication failed:", data.message);
                    alert(data.message);
                }
            } catch (error) {
                console.error("Error during sign-in:", error);
            }
        }

        window.googleLogin = googleLogin;
      </script>
{% endblock %}
